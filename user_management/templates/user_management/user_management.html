{% extends 'user_management/base.html' %}

{% block title %}User Management{% endblock %}

{% block content %}
<div class="card">
    <h2>User Management</h2>
    <p>Welcome to the user management page, {{ user.username }}!</p>
    
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}" style="padding: 10px; margin-bottom: 15px; border-radius: 4px; {% if message.tags == 'success' %}background-color: #d4edda; color: #155724;{% elif message.tags == 'error' %}background-color: #f8d7da; color: #721c24;{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <div class="admin-menu" style="margin-bottom: 20px;">
        <a href="{% url 'admin_dashboard' %}" style="text-decoration: none;">
            <button>Dashboard</button>
        </a>
        <a href="{% url 'user_management' %}" style="text-decoration: none;">
            <button style="background-color: #555;">Users</button>
        </a>
    </div>
    
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background-color: #f2f2f2;">
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Username</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Email</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Name</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Role</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user_item in users %}
            <tr>
                <td style="padding: 10px; border: 1px solid #ddd;">{{ user_item.username }}</td>
                <td style="padding: 10px; border: 1px solid #ddd;">{{ user_item.email }}</td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    {% if user_item.first_name or user_item.last_name %}
                        {{ user_item.first_name }} {{ user_item.last_name }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;">{{ user_item.get_role_display }}</td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    <a href="{% url 'edit_user' user_item.id %}" style="text-decoration: none;">
                        <button style="padding: 5px 10px; background-color: #4CAF50;">Edit</button>
                    </a>
                    
                    <form method="post" style="display: inline; margin-left: 5px;" onsubmit="return confirm('Are you sure you want to change {{ user_item.username }}\'s role?');">
                        {% csrf_token %}
                        <input type="hidden" name="user_id" value="{{ user_item.id }}">
                        <input type="hidden" name="action" value="change_role">
                        <select name="new_role" style="padding: 5px; max-width: 100px; margin-right: 5px;">
                            <option value="{{ user_item.USER }}" {% if user_item.role == user_item.USER %}selected{% endif %}>User</option>
                            <option value="{{ user_item.TEACHER }}" {% if user_item.role == user_item.TEACHER %}selected{% endif %}>Teacher</option>
                            <option value="{{ user_item.ADMIN }}" {% if user_item.role == user_item.ADMIN %}selected{% endif %}>Admin</option>
                        </select>
                        <button type="submit" style="padding: 5px 10px;">Update Role</button>
                    </form>
                    
                    {% if user_item != user %}
                    <form method="post" style="display: inline; margin-left: 5px;" onsubmit="return confirm('Are you sure you want to delete {{ user_item.username }}? This action cannot be undone.');">
                        {% csrf_token %}
                        <input type="hidden" name="user_id" value="{{ user_item.id }}">
                        <input type="hidden" name="action" value="delete">
                        <button type="submit" style="background-color: #ff4444; padding: 5px 10px;">Delete</button>
                    </form>
                    {% else %}
                    <button disabled style="background-color: #ccc; padding: 5px 10px; cursor: not-allowed; margin-left: 5px;" title="You cannot delete your own account">Delete</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div style="margin-top: 20px;">
        <h3>Add New User</h3>
        <p>To add a new user, go to the <a href="{% url 'register' %}">registration page</a>.</p>
    </div>
</div>
{% endblock %}